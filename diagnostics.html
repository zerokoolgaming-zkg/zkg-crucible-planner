<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Diagnostics • ZKG</title>
  <link rel="icon" href="assets/img/logo.png"/>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .diag-card{background:#0c1d40;border:1px solid #2a3a66;border-radius:12px;padding:12px}
    .ok{color:#9fe39f} .bad{color:#ff8b8b} .lat{color:#9fb0d1;font-size:.9rem}
    .pinwrap{display:flex;gap:8px;align-items:center;justify-content:center;padding:16px}
    .pinwrap input{width:140px;padding:10px;border-radius:10px;border:1px solid #2a3a66;background:#0e1a33;color:#eaf0ff}
  </style>
</head>
<body>
<header class="msf-header">
  <a class="brand" href="./">
    <img class="logo" src="assets/img/logo.png" alt="ZKG Emblem"/>
    <h1>Diagnostics</h1>
  </a>
  <div class="energy-bg"></div>
  <div class="gold-underline"></div>
</header>

<main class="container ultra-wide">
  <section class="card" id="pinGate">
    <h2>Admin PIN</h2>
    <div class="pinwrap">
      <input id="pin" placeholder="Enter PIN" type="password" />
      <button id="pinBtn" class="btn primary">Unlock</button>
      <div id="pinMsg" class="muted"></div>
    </div>
  </section>

  <section class="card" id="diagMain" style="display:none">
    <h2>Live API Checks</h2>
    <div id="summary" class="muted">Loading…</div>
    <div class="grid" style="margin-top:12px">
      <div class="diag-card"><b>Ping</b><div id="resPing" class="muted">…</div></div>
      <div class="diag-card"><b>PNGs</b><div id="resPngs" class="muted">…</div></div>
      <div class="diag-card"><b>Teams</b><div id="resTeams" class="muted">…</div></div>
    </div>
  </section>
</main>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbweQfrrV7MW5Z49MxYWe6nQ25Y5whGe_VHXZ6-gkR8x/exec";
const PIN = "2479";

document.getElementById('pinBtn').addEventListener('click', () => {
  const v = document.getElementById('pin').value;
  if (v === PIN) {
    document.getElementById('pinGate').style.display = 'none';
    document.getElementById('diagMain').style.display = '';
    run();
    setInterval(run, 30000);
  } else {
    document.getElementById('pinMsg').textContent = 'Invalid PIN';
  }
});

async function probe(url) {
  const t0 = performance.now();
  const r = await fetch(url + '&_=' + Date.now());
  const dt = Math.round(performance.now() - t0);
  let ok=false, msg='';
  try { const j = await r.json(); ok = !!(j && j.ok); msg = j.error || 'OK'; }
  catch(e){ msg = 'Bad JSON'; }
  return { ok, dt, msg, status: r.status };
}

async function run(){
  const s = document.getElementById('summary');
  const [p, g, t] = await Promise.all([
    probe(API_URL+'?action=ping'),
    probe(API_URL+'?action=getpngmap'),
    probe(API_URL+'?action=getteams')
  ]);
  s.innerHTML = 
    'Ping: ' + (p.ok?'<b class="ok">OK</b>':'<b class="bad">FAIL</b>') + ' <span class="lat">('+p.dt+'ms)</span> • ' +
    'PNGs: ' + (g.ok?'<b class="ok">OK</b>':'<b class="bad">FAIL</b>') + ' <span class="lat">('+g.dt+'ms)</span> • ' +
    'Teams: ' + (t.ok?'<b class="ok">OK</b>':'<b class="bad">FAIL</b>') + ' <span class="lat">('+t.dt+'ms)</span>';
  document.getElementById('resPing').textContent = p.ok? 'OK ('+p.dt+'ms)' : 'FAIL '+p.status+' '+p.msg;
  document.getElementById('resPngs').textContent = g.ok? 'OK ('+g.dt+'ms)' : 'FAIL '+g.status+' '+g.msg;
  document.getElementById('resTeams').textContent = t.ok? 'OK ('+t.dt+'ms)' : 'FAIL '+t.status+' '+t.msg;
}
</script>
</body>
</html>
