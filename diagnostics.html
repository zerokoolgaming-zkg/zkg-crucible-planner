<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Diagnostics • ZKG</title>
  <link rel="icon" href="assets/img/logo.png"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <style>
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    .diag-card{background:#0c1d40;border:1px solid #2a3a66;border-radius:12px;padding:10px}
    .ok{color:#9fe39f} .bad{color:#ff8b8b}
    .pinwrap{display:flex;gap:8px;align-items:center;justify-content:center;padding:16px}
    .pinwrap input{width:120px;padding:8px;border-radius:8px;border:1px solid #2a3a66;background:#0e1a33;color:#eaf0ff}
  </style>
</head>
<body>
<header class="msf-header"><div class="header-inner"><div class="brand"><img class="logo" src="assets/img/logo.png" alt="ZKG Emblem"/><h1>Diagnostics</h1></div></div><div class="energy-bg"></div><div class="gold-underline"></div></header>

<main class="container ultra-wide">
  <section class="card" id="pinGate">
    <h2>Admin PIN</h2>
    <div class="pinwrap">
      <input id="pin" placeholder="Enter PIN" type="password" />
      <button id="pinBtn" class="btn primary">Unlock</button>
      <div id="pinMsg" class="muted"></div>
    </div>
  </section>

  <section class="card" id="diagMain" style="display:none">
    <h2>Live API Checks</h2>
    <div id="summary" class="muted">Loading…</div>
  </section>

  <section class="card" id="pngSec" style="display:none">
    <h2>PNG Map</h2>
    <div id="pngGrid" class="grid"></div>
  </section>

  <section class="card" id="teamSec" style="display:none">
    <h2>Teams</h2>
    <div id="teamGrid" class="grid"></div>
  </section>
</main>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwgqUa14K4cMZVDP7qxg6rqDs17vGKSiWCVJOavIA-D0oC6o2SkhvqwJHuJ4oZdqtE/exec";
const PIN = "2479";
const pinInput = document.getElementById('pin');
document.getElementById('pinBtn').addEventListener('click', () => {
  if (pinInput.value === PIN) {
    document.getElementById('pinGate').style.display = 'none';
    document.getElementById('diagMain').style.display = '';
    document.getElementById('pngSec').style.display = '';
    document.getElementById('teamSec').style.display = '';
    runDiagnostics();
  } else {
    document.getElementById('pinMsg').textContent = 'Invalid PIN';
  }
});

async function runDiagnostics(){
  const s=document.getElementById('summary');
  try{
    const [ping,png,tms] = await Promise.all([
      fetch(API_URL+'?action=ping').then(r=>r.json()).catch(()=>({ok:false})),
      fetch(API_URL+'?action=getpngmap').then(r=>r.json()).catch(()=>({ok:false})),
      fetch(API_URL+'?action=getteams').then(r=>r.json()).catch(()=>({ok:false}))
    ]);
    s.innerHTML='Ping: '+(ping.ok?'<b class="ok">OK</b>':'<b class="bad">FAIL</b>')+
                ' • PNGs: '+(png.ok?'<b class="ok">OK</b>':'<b class="bad">FAIL</b>')+
                ' • Teams: '+(tms.ok?'<b class="ok">OK</b>':'<b class="bad">FAIL</b>');
    if(png.ok){
      const grid=document.getElementById('pngGrid');
      const entries=Object.entries(png.map||{}).slice(0,200);
      grid.innerHTML=entries.map(([name,url])=>`<div class="diag-card"><div style="display:flex;gap:8px;align-items:center"><img src="${url}" style="width:48px;height:48px;border-radius:8px"/><div><b>${name}</b><div class="muted" style="font-size:.8rem">${url.slice(0,70)}…</div></div></div></div>`).join('');
    }
    if(tms.ok){
      const grid=document.getElementById('teamGrid');
      const teams=(tms.teams||[]);
      grid.innerHTML=teams.map(t=>`<div class="diag-card"><b>${(t.name||t.team)}</b><div class="muted">${(t.members||[]).join(', ')}</div></div>`).join('');
    }
  }catch(e){ s.textContent='Diagnostics error: '+e.message; }
}
</script>
</body>
</html>
