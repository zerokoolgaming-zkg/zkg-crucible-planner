const API_URL=window.API_URL;const teamSelect=document.getElementById("teamSelect"),charSelects=[...document.querySelectorAll(".charSelect")],resultEl=document.getElementById("result"),banner=document.getElementById("banner"),retryBtn=document.getElementById("retryBtn");let characters=[],teams=[],pngMap={};retryBtn.onclick=()=>init();init();async function init(){banner.classList.add("hidden");try{await loadAll();buildUI();}catch(e){banner.classList.remove("hidden");console.error(e);}}
async function loadAll(){const j=await Promise.all([fetch(API_URL+'?action=getcharacters').then(r=>r.json()),fetch(API_URL+'?action=getteams').then(r=>r.json()),fetch(API_URL+'?action=getpngmap').then(r=>r.json())]);if(j.some(x=>!x.ok))throw new Error('Missing data');characters=j[0].characters||[];teams=(j[1].teams||[]).map(t=>({name:t.team,members:t.members||[]}));pngMap=j[2].map||{};}
function buildUI(){teamSelect.innerHTML='<option value="">(Optional) Choose a Team</option>'+teams.map(t=>`<option value="${t.name}">${t.name}</option>`).join('');const opts='<option value="">Choose character</option>'+characters.map(n=>`<option value="${n}">${n}</option>`).join('');charSelects.forEach(s=>{s.innerHTML=opts;s.onchange=e=>updatePreview(e.target);});teamSelect.onchange=()=>{const t=teams.find(x=>x.name===teamSelect.value);if(!t)return;t.members.forEach((m,i)=>{if(charSelects[i]){charSelects[i].value=m;updatePreview(charSelects[i]);}})};}
function updatePreview(sel){const blk=sel.closest('.dropdown-block');const img=blk.querySelector('img');const ph=blk.querySelector('.missing-ph');const u=pngMap[(sel.value||'').toLowerCase().replace(/_/g,' ').trim()]||'';if(u){img.src=u;img.style.display='block';ph.style.display='none';}else{img.removeAttribute('src');img.style.display='none';ph.style.display='flex';}}